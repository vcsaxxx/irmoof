# Скрываем консоль полностью
$windowCode = '[DllImport("user32.dll")] public static extern bool ShowWindow(int hWnd, int nCmdShow);'
$windowAPI = Add-Type -MemberDefinition $windowCode -Name Win32ShowWindow -Namespace Win32Functions -PassThru
$windowAPI::ShowWindow((Get-Process -PID $pid).MainWindowHandle, 0)

# Создаем безопасное окно симуляции
Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

$form = New-Object System.Windows.Forms.Form
$form.Text = "Xtrojan"
$form.Width = 500
$form.Height = 200
$form.StartPosition = "CenterScreen"
$form.ControlBox = $false
$form.MinimizeBox = $false
$form.MaximizeBox = $false
$form.FormBorderStyle = 'Fixed3D'
$form.TopMost = $true
$form.BackColor = [System.Drawing.Color]::Black

# Заголовок
$titleLabel = New-Object System.Windows.Forms.Label
$titleLabel.Location = New-Object System.Drawing.Point(0, 10)
$titleLabel.Size = New-Object System.Drawing.Size(500, 40)
$titleLabel.Text = "X T R O J A N"
$titleLabel.Font = New-Object System.Drawing.Font("Consolas", 20, [System.Drawing.FontStyle]::Bold)
$titleLabel.ForeColor = [System.Drawing.Color]::Lime
$titleLabel.TextAlign = "MiddleCenter"
$form.Controls.Add($titleLabel)

# Прогресс-бар
$progressBar = New-Object System.Windows.Forms.ProgressBar
$progressBar.Location = New-Object System.Drawing.Point(50, 80)
$progressBar.Size = New-Object System.Drawing.Size(400, 30)
$progressBar.Style = "Continuous"
$progressBar.ForeColor = [System.Drawing.Color]::Red
$progressBar.BackColor = [System.Drawing.Color]::DarkGray
$form.Controls.Add($progressBar)

# Статус
$statusLabel = New-Object System.Windows.Forms.Label
$statusLabel.Location = New-Object System.Drawing.Point(50, 120)
$statusLabel.Size = New-Object System.Drawing.Size(400, 20)
$statusLabel.Text = "Инициализация системы..."
$statusLabel.Font = New-Object System.Drawing.Font("Arial", 10)
$statusLabel.ForeColor = [System.Drawing.Color]::White
$form.Controls.Add($statusLabel)

# Проценты
$percentLabel = New-Object System.Windows.Forms.Label
$percentLabel.Location = New-Object System.Drawing.Point(50, 140)
$percentLabel.Size = New-Object System.Drawing.Size(400, 20)
$percentLabel.Text = "0%"
$percentLabel.Font = New-Object System.Drawing.Font("Arial", 12, [System.Drawing.FontStyle]::Bold)
$percentLabel.ForeColor = [System.Drawing.Color]::Yellow
$percentLabel.TextAlign = "MiddleCenter"
$form.Controls.Add($percentLabel)

# Блокируем закрытие
$form.Add_Closing({
    param($sender, $e)
    $e.Cancel = $true
})

# Показываем окно
$form.Show()
$form.TopMost = $true

# Функция обновления прогресса
function Update-Progress {
    param($percent, $status)
    
    $progressBar.Value = $percent
    $statusLabel.Text = $status
    $percentLabel.Text = "$percent%"
    $form.Refresh()
    [System.Windows.Forms.Application]::DoEvents()
    
    # Имитация работы
    Start-Sleep -Milliseconds (Get-Random -Minimum 100 -Maximum 500)
}

# Симуляция безопасного "сбора данных" без реальных действий
function Simulate-Safe-Collection {
    # Этап 1: Подготовка
    Update-Progress -percent 10 -status "Анализ системных параметров..."
    Start-Sleep -Seconds 1
    
    # Этап 2: Имитация сканирования
    Update-Progress -percent 25 -status "Сканирование файловой системы..."
    for ($i = 1; $i -le 15; $i++) {
        Update-Progress -percent (25 + $i) -status "Обработано $i из 15 разделов..."
    }
    
    # Этап 3: Имитация сбора
    Update-Progress -percent 45 -status "Обнаружение браузеров..."
    $fakeBrowsers = @("Chrome", "Edge", "Firefox", "Opera")
    foreach ($browser in $fakeBrowsers) {
        Update-Progress -percent (45 + (($fakeBrowsers.IndexOf($browser) + 1) * 5)) -status "Обработка $browser..."
        Start-Sleep -Milliseconds 800
    }
    
    # Этап 4: Имитация извлечения
    Update-Progress -percent 70 -status "Извлечение данных авторизации..."
    for ($i = 1; $i -le 10; $i++) {
        Update-Progress -percent (70 + $i * 2) -status "Найдено учетных записей: $i"
        Start-Sleep -Milliseconds 300
    }
    
    # Этап 5: Имитация упаковки
    Update-Progress -percent 95 -status "Шифрование и упаковка данных..."
    Start-Sleep -Seconds 2
    
    # Этап 6: Завершение
    Update-Progress -percent 100 -status "Операция успешно завершена!"
}

# Основной процесс
try {
    # Запускаем симуляцию
    Simulate-Safe-Collection
    
    # Показываем финальное сообщение
    $statusLabel.Text = "СИМУЛЯЦИЯ ЗАВЕРШЕНА. Система в безопасности."
    $statusLabel.ForeColor = [System.Drawing.Color]::Green
    $titleLabel.Text = "ТЕСТ ПРОЙДЕН"
    $titleLabel.ForeColor = [System.Drawing.Color]::Cyan
    $form.Refresh()
    
    Start-Sleep -Seconds 3
    
    # Меняем сообщение на финальное
    $statusLabel.Text = "Окно закроется автоматически через 5 секунд..."
    $form.Refresh()
    
    Start-Sleep -Seconds 5
    
    # Разрешаем закрытие
    $form.Remove_Closing({})
    
    # Плавно закрываем окно
    for ($i = 100; $i -ge 0; $i -= 5) {
        $form.Opacity = $i / 100
        $form.Refresh()
        Start-Sleep -Milliseconds 50
    }
    
} catch {
    # В случае ошибки просто закрываем
    Write-Error $_
} finally {
    # Гарантированно закрываем форму
    if ($form.Visible) {
        $form.Close()
        $form.Dispose()
    }
    
    # Восстанавливаем нормальное состояние
    [System.Windows.Forms.Application]::Exit()
}

# Создаем временный файл отчета (безопасный)
$reportContent = @"
=== ОТЧЕТ СИМУЛЯЦИИ XTROJAN ===
Время запуска: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
Пользователь: $env:USERNAME
Компьютер: $env:COMPUTERNAME
Статус: СИМУЛЯЦИЯ (без реальных действий)
Описание: Данный скрипт был демонстрацией без фактического сбора данных.
Безопасность системы: НЕ НАРУШЕНА
Файлы: НЕ СОЗДАВАЛОСЬ
Данные: НЕ СОБИРАЛОСЬ
Изменения: НЕ ВНОСИЛОСЬ
=== КОНЕЦ ОТЧЕТА ===
"@

# Сохраняем отчет на рабочий стол (опционально)
$reportPath = "$env:USERPROFILE\Desktop\Xtrojan_Simulation_Report.txt"
$reportContent | Out-File -FilePath $reportPath -Encoding UTF8

# Показываем уведомление о завершении (опционально)
$notification = New-Object -ComObject Wscript.Shell
$notification.Popup("Симуляция Xtrojan завершена.`nСистема работает в нормальном режиме.`n`nОтчет сохранен на рабочем столе.", 5, "Информация", 64)

# Очистка
[System.GC]::Collect()

